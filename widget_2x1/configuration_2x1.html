<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml">
        <head>
            <script src="../lib/VSS.SDK.min.js"></script>
            <script src="../library.js"></script>
            <link rel="stylesheet" href="../styles.css" />

            <script type="text/javascript">
                VSS.init({
                    explicitNotifyLoaded: true,
                    usePlatformStyles: true
                });

                VSS.require(["VSS/Service", "TFS/Dashboards/WidgetHelpers", "VSS/Context", "TFS/VersionControl/GitRestClient"],
                  function (Service, WidgetHelpers, context, GitWebApi) {
                    VSS.register("GHAzDoWidget.Configuration", function () {
                        var $repoDropdown = $("#repo-dropdown");

                        return {
                            load: async function (widgetSettings, widgetConfigurationContext) {
                                var settings = logWidgetSettings(widgetSettings, VSS, "2x1");

                                let repos = [];
                                const dataService = await VSS.getService(VSS.ServiceIds.ExtensionData);
                                try {
                                    const document = await dataService.getDocument("repos", "repositoryList");
                                    consoleLog("Doc retrieved from service:");
                                    consoleLog(JSON.stringify(document));
                                    repos = document.repos;
                                }
                                catch (e) {
                                    consoleLog(`Error getting the repos from the data service: ${e}`)
                                }

                                if (!repos || repos.length === 0) {
                                    consoleLog("No repos found in the data service, loading them from the API");
                                    // get a new list of repos for this project
                                    repos = await getRepos(VSS, Service, GitWebApi);

                                    // store the repos in the dataService: (default is project collection scope)
                                    dataService.createDocument("repos", {id: "repositoryList", lastUpdated: new Date(), repos}).then(function(doc) {
                                        // Even if no ID was passed to createDocument, one gets generated
                                        consoleLog(`New document was created with ID: ${doc.id}` );
                                    });
                                }

                                // add all repos as selection options to the dropdown
                                if (repos) {
                                    // add a top option to select no repo
                                    $repoDropdown.append(`<option value="">Select a repository</option>`);
                                    // sort the repo alphabetically
                                    repos.sort((a, b) => a.name.localeCompare(b.name));
                                    repos.forEach(r => {
                                        $repoDropdown.append(`<option value=${r.name}>${r.name}</option>`);
                                    });
                                }

                                if (settings && settings.repo) {
                                    // select the repo that was saved in the settings
                                     $repoDropdown.val(settings.repo);
                                 }

                                 $repoDropdown.on("change", function () {
                                    let repo;
                                    if (repos) {
                                        // find the repo with this name
                                        repo = repos.find(r => r.name === $repoDropdown.val());
                                    }

                                    var customSettings = {
                                        data: JSON.stringify({
                                                repo: $repoDropdown.val(),
                                                repoId: repo.id
                                            })
                                    };
                                    var eventName = WidgetHelpers.WidgetEvent.ConfigurationChange;
                                    var eventArgs = WidgetHelpers.WidgetEvent.Args(customSettings);
                                    widgetConfigurationContext.notify(eventName, eventArgs);
                                });

                                return WidgetHelpers.WidgetStatusHelper.Success();
                            },
                            onSave: async function() {
                                const repos = await getRepos(VSS, Service, GitWebApi);
                                let repo;
                                if (repos) {
                                    // find the repo with this name
                                    repo = repos.find(r => r.name === $repoDropdown.val());
                                }
                                var customSettings = {
                                    data: JSON.stringify({
                                            repo: $repoDropdown.val(),
                                            repoId: repo.id
                                        })
                                };
                                console.log(`Saving the settings with ${JSON.stringify(customSettings)}`)
                                return WidgetHelpers.WidgetConfigurationSave.Valid(customSettings);
                            }
                        }
                    });
                    VSS.notifyLoadSucceeded();
                });
            </script>
        </head>
        <body>
            <div class="container">
                <fieldset>
                    <label class="label">Repository: </label>
                    <select id="repo-dropdown" style="margin-top:10px">
                        <!-- todo: dynamically load the available repos in this project-->
                    </select>
                </fieldset>
            </div>
        </body>
    </html>